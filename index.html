<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Formulario Looker</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 20px; 
      background-color: #f5f5f5;
    }
    
    .container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    h2 {
      color: #333;
      margin-bottom: 30px;
      text-align: center;
    }
    
    label { 
      display: block; 
      margin-top: 15px; 
      margin-bottom: 5px;
      font-weight: bold;
      color: #555;
    }
    
    input, select { 
      width: 100%; 
      padding: 10px; 
      margin-top: 4px; 
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    
    input:disabled, select:disabled {
      background-color: #f8f8f8;
      color: #999;
      cursor: not-allowed;
    }
    
    button { 
      width: 100%; 
      margin-top: 25px; 
      background: #007bff; 
      color: white; 
      border: none; 
      cursor: pointer;
      padding: 12px;
      font-size: 16px;
      border-radius: 4px;
      transition: background-color 0.3s;
    }
    
    button:hover:not(:disabled) { 
      background: #0056b3; 
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .debug {
      margin-top: 20px;
      padding: 10px;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
      text-align: center;
    }
    
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Formulario Looker</h2>

    <form id="formulario">
      <label for="subproyecto">Subproyecto:</label>
      <select id="subproyecto" name="subproyecto" required>
        <option value="">Seleccione...</option>
      </select>

      <label for="rol">Rol:</label>
      <select id="rol" name="rol" required disabled>
        <option value="">Seleccione...</option>
      </select>
      
      <label for="num">Número:</label>
      <input type="text" id="num" name="num" disabled placeholder="Ingrese el número">
      
      <label for="unitario">Valor Unitario:</label>
      <input type="text" id="unitario" name="unitario" disabled placeholder="Ingrese el valor unitario">

      <button type="submit" id="guardar">Guardar</button>
    </form>
    
    <div id="status"></div>
    
    <!-- Debug info (puedes quitar esto en producción) -->
    <div class="debug" id="debug">
      Esperando datos...
    </div>
  </div>

  <script>
    // === CONFIG ===
    const API_URL = "https://script.google.com/macros/s/AKfycbxABuDOpk2CzYcHbfJjm6w0k4h-HVmNbL5aYDgzeSrb_a9U0ptrdpofTRH6E5VDGfEt/exec";
    
    // registros: array plano con objetos { subproyecto, rol, num, unitario, row }
    let registros = [];
    let subproyectos = [];

    // Función para mostrar debug info
    function debug(message) {
      console.log(message);
      const debugDiv = document.getElementById("debug");
      debugDiv.innerHTML += new Date().toLocaleTimeString() + ": " + JSON.stringify(message, null, 2) + "<br>";
      debugDiv.scrollTop = debugDiv.scrollHeight;
    }

    // Función para mostrar status
    function showStatus(message, isError = false) {
      const statusDiv = document.getElementById("status");
      statusDiv.className = `status ${isError ? 'error' : 'success'}`;
      statusDiv.textContent = message;
      statusDiv.style.display = 'block';
      
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 5000);
    }

    // ====== CARGA INICIAL ======
    async function cargarDatos() {
      debug("Iniciando carga de datos...");
      
      try {
        debug("Haciendo fetch a: " + API_URL);
        const resp = await fetch(API_URL);
        debug("Respuesta recibida, status: " + resp.status);
        
        const data = await resp.json();
        debug("Datos parseados:");
        debug(data);

        if (data.status === "ok") {
          // Guardar datos
          subproyectos = Array.isArray(data.subproyectos) ? data.subproyectos : [];
          registros = Array.isArray(data.registros) ? data.registros : [];
          
          debug(`Subproyectos encontrados: ${subproyectos.length}`);
          debug(`Registros encontrados: ${registros.length}`);

          // Llenar select subproyectos
          const select = document.getElementById("subproyecto");
          select.innerHTML = '<option value="">Seleccione...</option>';
          
          subproyectos.forEach(sp => {
            const opt = document.createElement("option");
            opt.value = sp;
            opt.textContent = sp;
            select.appendChild(opt);
          });

          // Reset estado dependientes
          resetRolYCampos();
          
          showStatus(`Datos cargados: ${subproyectos.length} subproyectos, ${registros.length} registros`);
        } else {
          debug("Error en respuesta del servidor:");
          debug(data);
          showStatus("Error al cargar datos: " + (data.message || "respuesta inválida"), true);
        }
      } catch (err) {
        debug("Error de conexión:");
        debug(err);
        showStatus("Error de conexión al cargar datos: " + err.message, true);
      }
    }

    function resetRolYCampos() {
      const rolSelect = document.getElementById("rol");
      rolSelect.innerHTML = '<option value="">Seleccione...</option>';
      rolSelect.disabled = true;

      const num = document.getElementById("num");
      const unitario = document.getElementById("unitario");
      num.value = "";
      unitario.value = "";
      num.disabled = true;
      unitario.disabled = true;

      delete document.getElementById("formulario").dataset.rowIndex;
      debug("Campos reseteados");
    }

    // ====== CUANDO CAMBIA SUBPROYECTO ======
    document.getElementById("subproyecto").addEventListener("change", function () {
      const seleccionado = this.value;
      debug(`Subproyecto seleccionado: ${seleccionado}`);
      
      const rolSelect = document.getElementById("rol");

      // limpiar roles
      rolSelect.innerHTML = '<option value="">Seleccione...</option>';

      if (!seleccionado) {
        rolSelect.disabled = true;
        resetRolYCampos();
        return;
      }

      // Filtrar registros por subproyecto y obtener roles únicos
      const registrosDelSubproyecto = registros.filter(r => 
        r.subproyecto === seleccionado
      );
      
      debug(`Registros para subproyecto ${seleccionado}:`);
      debug(registrosDelSubproyecto);

      // Obtener roles únicos (excluyendo valores vacíos o nulos)
      const roles = [...new Set(registrosDelSubproyecto
        .map(r => r.rol)
        .filter(rol => rol && String(rol).trim() !== "")
      )];

      debug(`Roles únicos encontrados: ${roles.length}`);
      debug(roles);

      if (roles.length === 0) {
        rolSelect.disabled = true;
        debug("No se encontraron roles para este subproyecto");
        showStatus("No hay roles disponibles para este subproyecto", true);
      } else {
        roles.forEach(rol => {
          const opt = document.createElement("option");
          opt.value = rol;
          opt.textContent = rol;
          rolSelect.appendChild(opt);
        });
        rolSelect.disabled = false;
        debug("Select de roles habilitado");
      }

      // limpiar campos dependientes
      document.getElementById("num").value = "";
      document.getElementById("unitario").value = "";
      document.getElementById("num").disabled = true;
      document.getElementById("unitario").disabled = true;
      delete document.getElementById("formulario").dataset.rowIndex;
    });

    // ====== CUANDO CAMBIA ROL ======
    document.getElementById("rol").addEventListener("change", function () {
      const subproyectoSel = document.getElementById("subproyecto").value;
      const rolSel = this.value;
      
      debug(`Rol seleccionado: ${rolSel} para subproyecto: ${subproyectoSel}`);

      if (!subproyectoSel || !rolSel) {
        document.getElementById("num").value = "";
        document.getElementById("unitario").value = "";
        document.getElementById("num").disabled = true;
        document.getElementById("unitario").disabled = true;
        delete document.getElementById("formulario").dataset.rowIndex;
        return;
      }

      // buscar registro exacto (si hay múltiples, toma el primero)
      const registro = registros.find(r => 
        r.subproyecto === subproyectoSel && r.rol === rolSel
      );
      
      debug("Registro encontrado:");
      debug(registro);

      if (registro) {
        document.getElementById("num").value = registro.num || "";
        document.getElementById("unitario").value = registro.unitario || "";
        document.getElementById("num").disabled = false;
        document.getElementById("unitario").disabled = false;
        // guardamos el índice de fila para actualizar después
        document.getElementById("formulario").dataset.rowIndex = registro.row;
        debug(`Campos cargados con datos existentes, fila: ${registro.row}`);
      } else {
        // rol sin registro existente, permitimos editar y luego crear
        document.getElementById("num").value = "";
        document.getElementById("unitario").value = "";
        document.getElementById("num").disabled = false;
        document.getElementById("unitario").disabled = false;
        delete document.getElementById("formulario").dataset.rowIndex;
        debug("No se encontró registro existente, campos habilitados para creación");
      }
    });

    // ====== GUARDAR (POST) ======
    document.getElementById("formulario").addEventListener("submit", async function (e) {
      e.preventDefault();
      const btn = document.getElementById("guardar");
      btn.disabled = true;
      btn.textContent = "Guardando...";

      const subproyecto = document.getElementById("subproyecto").value;
      const rol = document.getElementById("rol").value;
      const num = document.getElementById("num").value;
      const unitario = document.getElementById("unitario").value;
      const rowIndex = this.dataset.rowIndex ? parseInt(this.dataset.rowIndex, 10) : null;

      debug("Datos a enviar:");
      debug({ subproyecto, rol, num, unitario, rowIndex });

      // validaciones mínimas
      if (!subproyecto) { 
        showStatus("Seleccione un subproyecto", true);
        btn.disabled = false; 
        btn.textContent = "Guardar";
        return; 
      }
      if (!rol) { 
        showStatus("Seleccione un rol", true);
        btn.disabled = false; 
        btn.textContent = "Guardar";
        return; 
      }

      const payload = {
        subproyecto: subproyecto,
        rol: rol,
        num: num,
        unitario: unitario,
        row: rowIndex // null si es nuevo
      };

      debug("Payload final:");
      debug(payload);

      try {
        const resp = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        
        debug("Respuesta POST status: " + resp.status);
        
        const data = await resp.json();
        debug("Respuesta POST data:");
        debug(data);

        if (data.status === "ok") {
          showStatus(data.message || "✅ Guardado correctamente");
          // recargar datos para mantener sincronía con la hoja
          await cargarDatos();

          // opcional: volver a seleccionar el subproyecto y rol actual
          if (subproyecto) {
            document.getElementById("subproyecto").value = subproyecto;
            document.getElementById("subproyecto").dispatchEvent(new Event('change'));
            
            // Pequeña pausa para que se carguen los roles
            setTimeout(() => {
              if (rol) {
                document.getElementById("rol").value = rol;
                document.getElementById("rol").dispatchEvent(new Event('change'));
              }
            }, 100);
          }
        } else {
          showStatus("❌ Error al guardar: " + (data.message || "respuesta desconocida"), true);
        }
      } catch (err) {
        debug("Error al guardar:");
        debug(err);
        showStatus("Error de conexión al guardar: " + err.message, true);
      } finally {
        btn.disabled = false;
        btn.textContent = "Guardar";
      }
    });

    // Ejecutar carga inicial cuando se carga la página
    document.addEventListener('DOMContentLoaded', function() {
      debug("DOM cargado, iniciando aplicación...");
      cargarDatos();
    });
  </script>
</body>
</html>

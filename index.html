<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Formulario Looker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input, select, button {
      width: 300px;
      padding: 6px;
      margin-top: 4px;
    }
    button {
      width: 150px;
      margin-top: 15px;
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>
  <h2>Formulario Looker</h2>

  <form id="formulario">
    <label for="subproyecto">Subproyecto:</label>
    <select id="subproyecto" name="subproyecto" required>
      <option value="">Seleccione...</option>
    </select>

    <label for="rol">Rol:</label>
    <input type="text" id="rol" name="rol" required>

    <label for="num">Número:</label>
    <input type="number" id="num" name="num" required>

    <label for="unitario">Valor Unitario:</label>
    <input type="number" id="unitario" name="unitario" required>

    <button type="submit">Guardar</button>
  </form>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyHTyV2z82K8g3Rt7WUnb3YHnMjNoaS2CbpYIRvmNq9cv6eMtdCJ7INkV_M-bNsHX2n/exec";
    let registros = [];

    // Cargar datos iniciales
    async function cargarDatos() {
      try {
        const resp = await fetch(API_URL);
        const data = await resp.json();

        console.log("✅ Respuesta del backend:", data);

        if (data.status === "ok" && data.subproyectos && data.registros) {
          registros = data.registros;

          const select = document.getElementById("subproyecto");
          data.subproyectos.forEach(sp => {
            const opt = document.createElement("option");
            opt.value = sp;
            opt.textContent = sp;
            select.appendChild(opt);
          });
        } else {
          console.error("❌ Error en datos iniciales:", data);
          alert("No se pudieron cargar los datos iniciales.");
        }
      } catch (err) {
        console.error("❌ Error al cargar datos iniciales:", err);
        alert("Error de conexión al cargar datos iniciales.");
      }
    }

    // Cuando selecciona un subproyecto, rellenar los campos
    document.getElementById("subproyecto").addEventListener("change", function () {
      const seleccionado = this.value;
      const registro = registros.find(r => r.subproyecto === seleccionado);

      if (registro) {
        document.getElementById("rol").value = registro.rol;
        document.getElementById("num").value = registro.num;
        document.getElementById("unitario").value = registro.unitario;
      } else {
        console.warn("⚠️ No se encontró registro para:", seleccionado);
        document.getElementById("rol").value = "";
        document.getElementById("num").value = "";
        document.getElementById("unitario").value = "";
      }
    });

    // Guardar datos (POST al backend)
    document.getElementById("formulario").addEventListener("submit", async function (e) {
      e.preventDefault();

      const payload = {
        subproyecto: document.getElementById("subproyecto").value,
        rol: document.getElementById("rol").value,
        num: document.getElementById("num").value,
        unitario: document.getElementById("unitario").value
      };

      try {
        const resp = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();

        if (data.status === "ok") {
          alert("✅ Registro guardado correctamente.");
          document.getElementById("formulario").reset();
        } else {
          alert("❌ Error al guardar: " + data.message);
        }
      } catch (err) {
        console.error("❌ Error al guardar:", err);
        alert("Error de conexión al guardar.");
      }
    });

    // Ejecutar carga inicial
    cargarDatos();
  </script>
</body>
</html>

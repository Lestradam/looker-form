<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Formulario Looker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input, select, button {
      width: 300px;
      padding: 6px;
      margin-top: 4px;
    }
    button {
      width: 150px;
      margin-top: 15px;
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>
  <h2>Formulario Looker</h2>

  <form id="formulario">
    <label for="subproyecto">Subproyecto:</label>
    <select id="subproyecto" name="subproyecto" required>
      <option value="">Seleccione...</option>
    </select>

    <label for="rol">Rol:</label>
    <select id="rol" name="rol" required>
      <option value="">Seleccione...</option>
    </select>
    
    <label for="num">N√∫mero:</label>
    <input type="text" id="num" name="num" readonly>
    
    <label for="unitario">Valor Unitario:</label>
    <input type="text" id="unitario" name="unitario" readonly>

    <button type="submit">Guardar</button>
  </form>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxABuDOpk2CzYcHbfJjm6w0k4h-HVmNbL5aYDgzeSrb_a9U0ptrdpofTRH6E5VDGfEt/exec";
    let registros = [];

    // üëâ Cargar datos iniciales
    async function cargarDatos() {
      try {
        const resp = await fetch(API_URL);
        const data = await resp.json();
    
        console.log("‚úÖ Respuesta del backend:", data);
    
        if (data.status === "ok" && data.data) {
          // Transformamos el objeto en un array plano
          registros = [];
          const subproyectos = Object.keys(data.data);

          subproyectos.forEach(sp => {
            data.data[sp].forEach(r => {
              registros.push({
                subproyecto: sp,
                rol: r.rol,
                num: r.num,
                unitario: r.unitario
              });
            });
          });

          // llenar subproyectos en el select
          const select = document.getElementById("subproyecto");
          subproyectos.forEach(sp => {
            const opt = document.createElement("option");
            opt.value = sp;
            opt.textContent = sp;
            select.appendChild(opt);
          });
        } else {
          console.error("‚ùå Error en datos iniciales:", data);
          alert("No se pudieron cargar los datos iniciales.");
        }
      } catch (err) {
        console.error("‚ùå Error al cargar datos iniciales:", err);
        alert("Error de conexi√≥n al cargar datos iniciales.");
      }
    }
    
    // üëâ Cuando selecciona un subproyecto
    document.getElementById("subproyecto").addEventListener("change", function () {
      const seleccionado = this.value;
    
      // Filtrar registros que coincidan con el subproyecto
      const rolesDisponibles = registros.filter(r => r.subproyecto === seleccionado);
    
      const rolSelect = document.getElementById("rol");
      rolSelect.innerHTML = '<option value="">Seleccione...</option>';
    
      rolesDisponibles.forEach(r => {
        const opt = document.createElement("option");
        opt.value = r.rol;
        opt.textContent = r.rol;
        rolSelect.appendChild(opt);
      });
    
      // Limpiar campos dependientes
      document.getElementById("num").value = "";
      document.getElementById("unitario").value = "";
    });
    
    // üëâ Cuando selecciona un rol
    document.getElementById("rol").addEventListener("change", function () {
      const subproyectoSel = document.getElementById("subproyecto").value;
      const rolSel = this.value;
    
      // Buscar el registro exacto
      const registro = registros.find(r => r.subproyecto === subproyectoSel && r.rol === rolSel);
    
      if (registro) {
        document.getElementById("num").value = registro.num;
        document.getElementById("unitario").value = registro.unitario;
      } else {
        console.warn("‚ö†Ô∏è No se encontr√≥ info para:", subproyectoSel, rolSel);
        document.getElementById("num").value = "";
        document.getElementById("unitario").value = "";
      }
    });
    
    // üëâ Guardar datos (POST al backend)
    document.getElementById("formulario").addEventListener("submit", async function (e) {
      e.preventDefault();
    
      const payload = {
        subproyecto: document.getElementById("subproyecto").value,
        rol: document.getElementById("rol").value,
        num: document.getElementById("num").value,
        unitario: document.getElementById("unitario").value
      };
    
      try {
        const resp = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
    
        if (data.status === "ok") {
          alert("‚úÖ Registro guardado correctamente.");
          document.getElementById("formulario").reset();
        } else {
          alert("‚ùå Error al guardar: " + data.message);
        }
      } catch (err) {
        console.error("‚ùå Error al guardar:", err);
        alert("Error de conexi√≥n al guardar.");
      }
    });

    // üëâ Ejecutar carga inicial
    cargarDatos();
  </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Formulario</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    label { display: block; margin-top: 10px; }
    select, input, button { padding: 5px; margin-top: 5px; }
  </style>
</head>
<body>
  <h2>Registro</h2>

  <form id="registroForm">
    <label>Subproyecto:
      <select id="subproyectoSelect" required></select>
    </label>

    <label>Rol:
      <select id="rolSelect" required></select>
    </label>

    <label>#:
      <input type="number" id="numero" required>
    </label>

    <label>Unitario:
      <input type="number" step="0.01" id="unitario" required>
    </label>

    <button type="submit">Guardar</button>
  </form>

  <script>
    // üîπ Pega aqu√≠ la URL publicada de tu WebApp de Apps Script
    const API_URL = "https://script.google.com/macros/s/AKfycbxABuDOpk2CzYcHbfJjm6w0k4h-HVmNbL5aYDgzeSrb_a9U0ptrdpofTRH6E5VDGfEt/exec"; 

    let registros = []; // guardamos todos los registros

    // üîπ Cargar todos los registros al inicio
    async function cargarDatos() {
      try {
        const res = await fetch(API_URL);
        const data = await res.json();

        console.log("Respuesta del backend:", data); // üëà aqu√≠ vemos qu√© devuelve Apps Script

        if (data.status === "ok" && Array.isArray(data.registros)) {
          registros = data.registros;

          // llenar subproyectos √∫nicos
          const subSel = document.getElementById("subproyectoSelect");
          const subsUnicos = [...new Set(registros.map(r => r.subproyecto))];

          subSel.innerHTML = "<option value=''>Seleccione...</option>";
          subsUnicos.forEach(sp => {
            const option = document.createElement("option");
            option.value = sp;
            option.textContent = sp;
            subSel.appendChild(option);
          });
        } else {
          alert("‚ùå Error en datos iniciales: no llegaron registros");
          console.error("Respuesta inesperada:", data);
        }
      } catch (err) {
        console.error("Error al cargar datos iniciales", err);
        alert("‚ùå No se pudieron cargar datos iniciales");
      }
    }

    // üîπ Evento: cuando cambia el subproyecto ‚Üí cargar roles
    document.getElementById("subproyectoSelect").addEventListener("change", (e) => {
      const sub = e.target.value;
      const rolesFiltrados = registros.filter(r => r.subproyecto === sub);

      const rolSel = document.getElementById("rolSelect");
      rolSel.innerHTML = "<option value=''>Seleccione...</option>";
      rolesFiltrados.forEach(r => {
        const option = document.createElement("option");
        option.value = r.rol;
        option.textContent = r.rol;
        rolSel.appendChild(option);
      });

      // limpiar num y unitario
      document.getElementById("numero").value = "";
      document.getElementById("unitario").value = "";
    });

    // üîπ Evento: cuando cambia el rol ‚Üí llenar num y unitario
    document.getElementById("rolSelect").addEventListener("change", (e) => {
      const sub = document.getElementById("subproyectoSelect").value;
      const rol = e.target.value;

      const reg = registros.find(r => r.subproyecto === sub && r.rol === rol);
      if (reg) {
        document.getElementById("numero").value = reg.num || "";
        document.getElementById("unitario").value = reg.unitario || "";
      }
    });

    // üîπ Guardar nuevo registro en la hoja
    document.getElementById("registroForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const payload = {
        subproyecto: document.getElementById("subproyectoSelect").value,
        rol: document.getElementById("rolSelect").value,
        num: document.getElementById("numero").value,
        unitario: document.getElementById("unitario").value
      };

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await res.json();

        if (data.status === "ok") {
          alert("‚úÖ " + data.message);
          document.getElementById("registroForm").reset();
        } else {
          alert("‚ùå Error al guardar: " + data.message);
        }
      } catch (err) {
        console.error("Error al guardar", err);
        alert("‚ùå No se pudo guardar");
      }
    });

    // cargar datos iniciales al abrir la p√°gina
    window.onload = cargarDatos;
  </script>
</body>
</html>

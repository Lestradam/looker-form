<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Formulario</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    label { display: block; margin-top: 10px; }
    select, input, button { padding: 5px; margin-top: 5px; }
  </style>
</head>
<body>
  <h2>Registro</h2>

  <form id="registroForm">
    <label>Subproyecto:
      <select id="subproyectoSelect" required>
        <option>Cargando...</option>
      </select>
    </label>

    <label>Rol:
      <select id="rolSelect" required>
        <option>Cargando...</option>
      </select>
    </label>

    <label>#:
      <input type="number" id="numero" required>
    </label>

    <label>Unitario:
      <input type="number" step="0.01" id="unitario" required>
    </label>

    <button type="submit">Guardar</button>
  </form>

  <script>
    // üîπ Pega aqu√≠ tu URL del WebApp de Apps Script (debe terminar en /exec)
    const API_URL = "https://script.google.com/macros/s/AKfycbxABuDOpk2CzYcHbfJjm6w0k4h-HVmNbL5aYDgzeSrb_a9U0ptrdpofTRH6E5VDGfEt/exec";

    // üîπ Funci√≥n para poblar selects
    function poblarSelects(data) {
      // Subproyectos
      const subSel = document.getElementById("subproyectoSelect");
      subSel.innerHTML = "<option value=''>Seleccione...</option>";
      (data.subproyectos || []).forEach(sp => {
        const option = document.createElement("option");
        option.value = sp;
        option.textContent = sp;
        subSel.appendChild(option);
      });

      // Roles
      const rolSel = document.getElementById("rolSelect");
      rolSel.innerHTML = "<option value=''>Seleccione...</option>";
      (data.roles || []).forEach(r => {
        const option = document.createElement("option");
        option.value = r;
        option.textContent = r;
        rolSel.appendChild(option);
      });
    }

    // üîπ Cargar datos iniciales con cach√©
    async function cargarDatos() {
      try {
        // 1. Ver si hay cache
        const cache = localStorage.getItem("formCache");
        if (cache) {
          const cachedData = JSON.parse(cache);
          poblarSelects(cachedData);
        }

        // 2. Siempre intenta pedir al servidor para refrescar
        const res = await fetch(API_URL);
        const data = await res.json();

        if (data.status === "ok") {
          poblarSelects(data);
          // Guardar en cach√© por 10 min
          localStorage.setItem("formCache", JSON.stringify(data));
          localStorage.setItem("formCacheTime", Date.now());
        } else {
          console.error("Respuesta inesperada del servidor:", data);
          alert("‚ùå Error en datos iniciales: " + (data.message || "sin detalle"));
        }
      } catch (err) {
        console.error("Error al cargar datos iniciales", err);
        if (!localStorage.getItem("formCache")) {
          alert("‚ùå No se pudieron cargar datos iniciales");
        }
      }
    }

    // üîπ Enviar formulario
    document.getElementById("registroForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const payload = {
        subproyecto: document.getElementById("subproyectoSelect").value,
        rol: document.getElementById("rolSelect").value,
        num: document.getElementById("numero").value,
        unitario: document.getElementById("unitario").value
      };

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await res.json();

        if (data.status === "ok") {
          alert("‚úÖ " + data.message);
          document.getElementById("registroForm").reset();
        } else {
          alert("‚ùå Error al guardar: " + data.message);
        }
      } catch (err) {
        console.error("Error al guardar", err);
        alert("‚ùå No se pudo guardar");
      }
    });

    // üîπ Iniciar carga al abrir la p√°gina
    window.onload = cargarDatos;
  </script>
</body>
</html>

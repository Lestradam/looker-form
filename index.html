<!DOCTYPE html>
<html lang="es">
<head>
Â  <meta charset="UTF-8">
Â  <title>Formulario Looker - Debug con Columna L</title>
Â  <style>
Â  Â  body { font-family: Arial, sans-serif; margin: 20px; }
Â  Â  .container { max-width: 800px; margin: 0 auto; padding: 20px; }
Â  Â  label { display: block; margin-top: 15px; font-weight: bold; }
Â  Â  input, select { width: 100%; padding: 10px; margin-top: 4px; box-sizing: border-box; }
Â  Â  button { width: 100%; margin-top: 20px; padding: 12px; background: #007bff; color: white; border: none; cursor: pointer; }
Â  Â  .debug { margin-top: 20px; padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; font-family: monospace; font-size: 11px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; }
Â  Â  .status { margin-top: 10px; padding: 10px; border-radius: 4px; display: none; }
Â  Â  .success { background: #d4edda; color: #155724; }
Â  Â  .error { background: #f8d7da; color: #721c24; }
Â  Â  .debug-section { margin-top: 20px; padding: 15px; background: #e7f3ff; border: 2px solid #0066cc; border-radius: 5px; }
Â  Â  .debug-title { font-weight: bold; color: #0066cc; margin-bottom: 10px; }
Â  Â Â 
Â  Â  /* Nuevos estilos para el layout de 2 columnas */
Â  Â  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
Â  Â  .form-field { display: flex; flex-direction: column; }
Â  Â  .form-field label { margin-top: 0; margin-bottom: 5px; }
Â  Â  .full-width { grid-column: 1 / -1; }
Â  Â Â 
Â  Â  /* Estilo para el campo de bÃºsqueda de subproyecto */
Â  Â  .searchable-select { position: relative; }
Â  Â  .search-input {Â 
Â  Â  Â  width: 100%;Â 
Â  Â  Â  padding: 10px;Â 
Â  Â  Â  border: 1px solid #ccc;Â 
Â  Â  Â  border-radius: 4px;
Â  Â  Â  font-size: 14px;
Â  Â  }
Â  Â  .dropdown-list {Â 
Â  Â  Â  position: absolute;Â 
Â  Â  Â  top: 100%;Â 
Â  Â  Â  left: 0;Â 
Â  Â  Â  right: 0;Â 
Â  Â  Â  background: white;Â 
Â  Â  Â  border: 1px solid #ccc;Â 
Â  Â  Â  border-top: none;
Â  Â  Â  border-radius: 0 0 4px 4px;
Â  Â  Â  max-height: 200px;Â 
Â  Â  Â  overflow-y: auto;Â 
Â  Â  Â  z-index: 1000;Â 
Â  Â  Â  display: none;
Â  Â  }
Â  Â  .dropdown-item {Â 
Â  Â  Â  padding: 10px;Â 
Â  Â  Â  cursor: pointer;Â 
Â  Â  Â  border-bottom: 1px solid #eee;
Â  Â  }
Â  Â  .dropdown-item:hover {Â 
Â  Â  Â  background-color: #f0f0f0;Â 
Â  Â  }
Â  Â  .dropdown-item:last-child {Â 
Â  Â  Â  border-bottom: none;Â 
Â  Â  }
Â  Â  .dropdown-item.selected {Â 
Â  Â  Â  background-color: #007bff;Â 
Â  Â  Â  color: white;Â 
Â  Â  }
Â  Â Â 
Â  Â  /* Formato para campos monetarios */
Â  Â  .currency-field {
Â  Â  Â  position: relative;
Â  Â  }
Â  Â  .currency-field::before {
Â  Â  Â  content: '$';
Â  Â  Â  position: absolute;
Â  Â  Â  left: 10px;
Â  Â  Â  top: 50%;
Â  Â  Â  transform: translateY(-50%);
Â  Â  Â  color: #666;
Â  Â  Â  z-index: 1;
Â  Â  }
Â  Â  .currency-input {
Â  Â  Â  padding-left: 25px !important;
Â  Â  Â  text-align: right;
Â  Â  }
Â  </style>
</head>
<body>
Â  <div class="container">
Â  Â  <h2>Formulario Looker - VersiÃ³n Debug con Columna L</h2>
Â  Â Â 
Â  Â  <button onclick="testConnection()">ğŸ§ª Test ConexiÃ³n</button>
Â  Â  <button onclick="showFullDebug()">ğŸ“Š Mostrar Debug Completo</button>

Â  Â  <form id="formulario" onsubmit="return false;">
Â  Â  Â  Â  Â  Â  <div class="full-width">
Â  Â  Â  Â  <label>Subproyecto:</label>
Â  Â  Â  Â  <div class="searchable-select">
Â  Â  Â  Â  Â  <input type="text" id="subproyecto" class="search-input" placeholder="Buscar subproyecto..."Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â oninput="filterSubproyectos()" onclick="showDropdown()"
Â  Â  Â  Â  Â  Â  Â  Â  Â onkeydown="handleKeyNavigation()">
Â  Â  Â  Â  Â  <div id="subproyecto-dropdown" class="dropdown-list"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="form-row">
Â  Â  Â  Â  <div class="form-field">
Â  Â  Â  Â  Â  <label>Rol:</label>
Â  Â  Â  Â  Â  <select id="rol" disabled onchange="onRolChange()">
Â  Â  Â  Â  Â  Â  <option value="">Seleccione subproyecto primero</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="form-field">
Â  Â  Â  Â  Â  <label>NÃºmero:</label>
Â  Â  Â  Â  Â  <input type="text" id="num" disabled>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="form-row">
Â  Â  Â  Â  <div class="form-field">
Â  Â  Â  Â  Â  <label>Valor Unitario (Columna K):</label>
Â  Â  Â  Â  Â  <div class="currency-field">
Â  Â  Â  Â  Â  Â  <input type="text" id="unitario" class="currency-input" disabledÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â oninput="formatCurrency(this); calculateTotal()">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="form-field">
Â  Â  Â  Â  Â  <label>Valor Total (Columna L):</label>
Â  Â  Â  Â  Â  <div class="currency-field">
Â  Â  Â  Â  Â  Â  <input type="text" id="columnaL" class="currency-input" disabledÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â oninput="formatCurrency(this)">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="form-row">
Â  Â  Â  Â  <div class="form-field">
Â  Â  Â  Â  Â  <label>Tipo (Columna M):</label>
Â  Â  Â  Â  Â  <select id="tipo" disabled>
Â  Â  Â  Â  Â  Â  <option value="">Seleccione subproyecto primero</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="form-field">
Â  Â  Â  Â  Â  <label>Tipo de Personal (Columna N):</label>
Â  Â  Â  Â  Â  <select id="tipoPersonal" disabled>
Â  Â  Â  Â  Â  Â  <option value="">Seleccione subproyecto primero</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <button onclick="guardarDatos()" id="guardar" disabled>Guardar</button>
Â  Â  </form>
Â  Â Â 
Â  Â  <div id="status" class="status"></div>
Â  Â Â 
Â  Â  <div class="debug-section">
Â  Â  Â  <div class="debug-title">ğŸ” INFORMACIÃ“N DE DEBUG</div>
Â  Â  Â  <div id="debug-info">No hay informaciÃ³n de debug disponible</div>
Â  Â  </div>
Â  Â Â 
Â  Â  <div class="debug-section">
Â  Â  Â  <div class="debug-title">ğŸ“ LOG DE ACTIVIDAD</div>
Â  Â  Â  <div id="debug" class="debug">Iniciando aplicaciÃ³n...\n</div>
Â  Â  </div>
Â  </div>

Â  <script>
Â  Â  // === CONFIG - CAMBIA ESTA URL POR LA TUYA ===
Â  Â  const API_URL = "https://script.google.com/macros/s/AKfycbzD13x40paMguboGSMdb50QijK4V-1Lebo60queIMn8AAw_GSfY2if2ZxE3-6Fpvppw/exec";
Â  Â Â 
Â  Â  let registros = [];
Â  Â  let subproyectos = [];
Â  Â  let filteredSubproyectos = [];
Â  Â  let selectedSubproyectoIndex = -1;
Â  Â  let tiposUnicos = [];
Â  Â  let tiposPersonalUnicos = [];
Â  Â  let lastResponse = null; // Para guardar la Ãºltima respuesta completa

Â  Â  function log(message) {
Â  Â  Â  const timestamp = new Date().toLocaleTimeString();
Â  Â  Â  const debugDiv = document.getElementById("debug");
Â  Â  Â  debugDiv.textContent += `${timestamp}: ${JSON.stringify(message)}\n`;
Â  Â  Â  debugDiv.scrollTop = debugDiv.scrollHeight;
Â  Â  Â  console.log(message);
Â  Â  }

Â  Â  function showStatus(message, isError = false) {
Â  Â  Â  const statusDiv = document.getElementById("status");
Â  Â  Â  statusDiv.className = `status ${isError ? 'error' : 'success'}`;
Â  Â  Â  statusDiv.textContent = message;
Â  Â  Â  statusDiv.style.display = 'block';
Â  Â  Â  setTimeout(() => statusDiv.style.display = 'none', 5000);
Â  Â  }

Â  Â  function showFullDebug() {
Â  Â  Â  if (lastResponse && lastResponse.debug) {
Â  Â  Â  Â  const debugInfo = document.getElementById("debug-info");
Â  Â  Â  Â  debugInfo.innerHTML = `
Â  Â  Â  Â  Â  <strong>ğŸ“Š InformaciÃ³n de la Hoja:</strong><br>
Â  Â  Â  Â  Â  â€¢ Total de filas: ${lastResponse.debug.totalFilas}<br>
Â  Â  Â  Â  Â  â€¢ Total de columnas: ${lastResponse.debug.totalColumnas}<br>
Â  Â  Â  Â  Â  â€¢ Subproyectos Ãºnicos: ${lastResponse.debug.subproyectosUnicos}<br>
Â  Â  Â  Â  Â  â€¢ Total registros: ${lastResponse.debug.totalRegistros}<br>
Â  Â  Â  Â  Â  â€¢ Registros con rol: ${lastResponse.debug.registrosConRol}<br>
Â  Â  Â  Â  Â  â€¢ Tipos Ãºnicos: ${tiposUnicos.length}<br>
Â  Â  Â  Â  Â  â€¢ Tipos de personal Ãºnicos: ${tiposPersonalUnicos.length}<br><br>
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  <strong>ğŸ“‹ Encabezados encontrados:</strong><br>
Â  Â  Â  Â  Â  ${lastResponse.debug.encabezados.map((h, i) => `Col ${i+1}: "${h}"`).join('<br>')}<br><br>
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  <strong>ğŸ¯ Columnas utilizadas:</strong><br>
Â  Â  Â  Â  Â  â€¢ Subproyecto: Columna ${lastResponse.debug.columnasUsadas.subproyecto}<br>
Â  Â  Â  Â  Â  â€¢ Rol: Columna ${lastResponse.debug.columnasUsadas.rol}<br>
Â  Â  Â  Â  Â  â€¢ NÃºmero: Columna ${lastResponse.debug.columnasUsadas.num}<br>
Â  Â  Â  Â  Â  â€¢ Unitario: Columna ${lastResponse.debug.columnasUsadas.unitario}<br>
Â  Â  Â  Â  Â  â€¢ Columna L: Columna ${lastResponse.debug.columnasUsadas.columnaL}<br>
Â  Â  Â  Â  Â  â€¢ Tipo: Columna ${lastResponse.debug.columnasUsadas.tipo}<br>
Â  Â  Â  Â  Â  â€¢ Tipo Personal: Columna ${lastResponse.debug.columnasUsadas.tipoPersonal}<br><br>
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  <strong>ğŸ·ï¸ Headers de columnas importantes:</strong><br>
Â  Â  Â  Â  Â  â€¢ Columna K: "${lastResponse.debug.columnaKHeader}"<br>
Â  Â  Â  Â  Â  â€¢ Columna L: "${lastResponse.debug.columnaLHeader}"<br>
Â  Â  Â  Â  Â  â€¢ Columna M: "${lastResponse.debug.columnaMHeader}"<br>
Â  Â  Â  Â  Â  â€¢ Columna N: "${lastResponse.debug.columnaNHeader}"<br><br>
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  <strong>ğŸ¨ Valores Ãºnicos encontrados:</strong><br>
Â  Â  Â  Â  Â  â€¢ Tipos (M): ${tiposUnicos.length > 0 ? tiposUnicos.join(', ') : 'Ninguno'}<br>
Â  Â  Â  Â  Â  â€¢ Tipos Personal (N): ${tiposPersonalUnicos.length > 0 ? tiposPersonalUnicos.join(', ') : 'Ninguno'}<br><br>
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  <strong>ğŸ“ Primeros 3 registros:</strong><br>
Â  Â  Â  Â  Â  ${lastResponse.debug.primeros3Registros ?Â 
Â  Â  Â  Â  Â  Â  lastResponse.debug.primeros3Registros.map(r =>Â 
Â  Â  Â  Â  Â  Â  Â  `â€¢ "${r.subproyecto}" | "${r.rol}" | "${r.num}" | K:"${r.unitario}" | L:"${r.columnaL}" | M:"${r.tipo}" | N:"${r.tipoPersonal}"`
Â  Â  Â  Â  Â  Â  ).join('<br>') : 'No hay registros'}
Â  Â  Â  Â  `;
Â  Â  Â  } else {
Â  Â  Â  Â  document.getElementById("debug-info").innerHTML = "âŒ No hay informaciÃ³n de debug. Ejecuta 'Cargar Datos' primero.";
Â  Â  Â  }
Â  Â  }

Â  Â  async function testConnection() {
Â  Â  Â  log("ğŸ§ª Probando conexiÃ³n...");
Â  Â  Â  try {
Â  Â  Â  Â  const response = await fetch(API_URL);
Â  Â  Â  Â  log("Response status: " + response.status);
Â  Â  Â  Â  log("Response headers: " + JSON.stringify([...response.headers.entries()]));
Â  Â  Â  Â Â 
Â  Â  Â  Â  const text = await response.text();
Â  Â  Â  Â  log("Response text (primeros 500 chars): " + text.substring(0, 500));
Â  Â  Â  Â Â 
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  const json = JSON.parse(text);
Â  Â  Â  Â  Â  log("JSON parseado exitosamente");
Â  Â  Â  Â  Â  log("Estructura completa del JSON:");
Â  Â  Â  Â  Â  log(json);
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  // Mostrar debug si estÃ¡ disponible
Â  Â  Â  Â  Â  if (json.debug) {
Â  Â  Â  Â  Â  Â  log("=== INFORMACIÃ“N DE DEBUG ===");
Â  Â  Â  Â  Â  Â  log("Total filas: " + json.debug.totalFilas);
Â  Â  Â  Â  Â  Â  log("Total columnas: " + json.debug.totalColumnas);
Â  Â  Â  Â  Â  Â  log("Encabezados: " + JSON.stringify(json.debug.encabezados));
Â  Â  Â  Â  Â  Â  log("Columnas usadas: " + JSON.stringify(json.debug.columnasUsadas));
Â  Â  Â  Â  Â  Â  log("Registros encontrados: " + json.debug.totalRegistros);
Â  Â  Â  Â  Â  Â  log("Primeros 3 registros: " + JSON.stringify(json.debug.primeros3Registros));
Â  Â  Â  Â  Â  Â  log("Header Columna K: " + json.debug.columnaKHeader);
Â  Â  Â  Â  Â  Â  log("Header Columna L: " + json.debug.columnaLHeader);
Â  Â  Â  Â  Â  Â  log("Header Columna M: " + json.debug.columnaMHeader);
Â  Â  Â  Â  Â  Â  log("Header Columna N: " + json.debug.columnaNHeader);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  } catch(e) {
Â  Â  Â  Â  Â  log("Error parseando JSON: " + e.message);
Â  Â  Â  Â  }
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  log("âŒ Error de conexiÃ³n: " + error.message);
Â  Â  Â  }
Â  Â  }

Â  Â  function resetFormFields() {
Â  Â  Â  // Restablecer todos los campos excepto subproyecto
Â  Â  Â  document.getElementById("rol").innerHTML = '<option value="">Seleccione subproyecto primero</option>';
Â  Â  Â  document.getElementById("rol").disabled = true;
Â  Â  Â  document.getElementById("num").value = "";
Â  Â  Â  document.getElementById("num").disabled = true;
Â  Â  Â  document.getElementById("unitario").value = "";
Â  Â  Â  document.getElementById("unitario").disabled = true;
Â  Â  Â  document.getElementById("columnaL").value = "";
Â  Â  Â  document.getElementById("columnaL").disabled = true;
Â  Â  Â  document.getElementById("tipo").innerHTML = '<option value="">Seleccione rol primero</option>';
Â  Â  Â  document.getElementById("tipo").disabled = true;
Â  Â  Â  document.getElementById("tipoPersonal").innerHTML = '<option value="">Seleccione rol primero</option>';
Â  Â  Â  document.getElementById("tipoPersonal").disabled = true;
Â  Â  Â  document.getElementById("guardar").disabled = true;
Â  Â  Â Â 
Â  Â  Â  // Limpiar el Ã­ndice de fila
Â  Â  Â  delete document.getElementById("formulario").dataset.rowIndex;
Â  Â  Â Â 
Â  Â  Â  log("ğŸ”„ Campos del formulario restablecidos");
Â  Â  }

Â  Â  // Funciones para el campo de bÃºsqueda de subproyectos
Â  Â  function filterSubproyectos() {
Â  Â  Â  const input = document.getElementById("subproyecto");
Â  Â  Â  const query = input.value.toLowerCase();
Â  Â  Â Â 
Â  Â  Â  if (query === "") {
Â  Â  Â  Â  filteredSubproyectos = [...subproyectos];
Â  Â  Â  } else {
Â  Â  Â  Â  filteredSubproyectos = subproyectos.filter(subproyecto =>Â 
Â  Â  Â  Â  Â  subproyecto.toLowerCase().includes(query)
Â  Â  Â  Â  );
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  selectedSubproyectoIndex = -1;
Â  Â  Â  updateDropdown();
Â  Â  Â  showDropdown();
Â  Â  }

Â  Â  function updateDropdown() {
Â  Â  Â  const dropdown = document.getElementById("subproyecto-dropdown");
Â  Â  Â  dropdown.innerHTML = "";
Â  Â  Â Â 
Â  Â  Â  if (filteredSubproyectos.length === 0) {
Â  Â  Â  Â  const item = document.createElement("div");
Â  Â  Â  Â  item.className = "dropdown-item";
Â  Â  Â  Â  item.textContent = "No se encontraron coincidencias";
Â  Â  Â  Â  item.style.color = "#999";
Â  Â  Â  Â  dropdown.appendChild(item);
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  filteredSubproyectos.forEach((subproyecto, index) => {
Â  Â  Â  Â  const item = document.createElement("div");
Â  Â  Â  Â  item.className = "dropdown-item";
Â  Â  Â  Â  if (index === selectedSubproyectoIndex) {
Â  Â  Â  Â  Â  item.classList.add("selected");
Â  Â  Â  Â  }
Â  Â  Â  Â  item.textContent = subproyecto;
Â  Â  Â  Â  item.onmousedown = () => selectSubproyecto(subproyecto);
Â  Â  Â  Â  dropdown.appendChild(item);
Â  Â  Â  });
Â  Â  }

Â  Â  function showDropdown() {
Â  Â  Â  if (filteredSubproyectos.length === 0) {
Â  Â  Â  Â  filteredSubproyectos = [...subproyectos];
Â  Â  Â  Â  updateDropdown();
Â  Â  Â  }
Â  Â  Â  document.getElementById("subproyecto-dropdown").style.display = "block";
Â  Â  }

Â  Â  function hideDropdown() {
Â  Â  Â  document.getElementById("subproyecto-dropdown").style.display = "none";
Â  Â  }

Â  Â  function handleKeyNavigation(event) {
Â  Â  Â  const dropdown = document.getElementById("subproyecto-dropdown");
Â  Â  Â Â 
Â  Â  Â  if (dropdown.style.display === "none") return;
Â  Â  Â Â 
Â  Â  Â  switch(event.key) {
Â  Â  Â  Â  case "ArrowDown":
Â  Â  Â  Â  Â  event.preventDefault();
Â  Â  Â  Â  Â  selectedSubproyectoIndex = Math.min(selectedSubproyectoIndex + 1, filteredSubproyectos.length - 1);
Â  Â  Â  Â  Â  updateDropdown();
Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  case "ArrowUp":
Â  Â  Â  Â  Â  event.preventDefault();
Â  Â  Â  Â  Â  selectedSubproyectoIndex = Math.max(selectedSubproyectoIndex - 1, -1);
Â  Â  Â  Â  Â  updateDropdown();
Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  case "Enter":
Â  Â  Â  Â  Â  event.preventDefault();
Â  Â  Â  Â  Â  if (selectedSubproyectoIndex >= 0 && selectedSubproyectoIndex < filteredSubproyectos.length) {
Â  Â  Â  Â  Â  Â  selectSubproyecto(filteredSubproyectos[selectedSubproyectoIndex]);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  case "Escape":
Â  Â  Â  Â  Â  hideDropdown();
Â  Â  Â  Â  Â  break;
Â  Â  Â  }
Â  Â  }

Â  Â  function selectSubproyecto(subproyecto) {
Â  Â  Â  document.getElementById("subproyecto").value = subproyecto;
Â  Â  Â  hideDropdown();
Â  Â  Â  onSubproyectoChange(subproyecto);
Â  Â  }

Â  Â  // Funciones para formateo de moneda
Â  Â  function formatCurrency(input) {
Â  Â  Â  let value = input.value.replace(/[^\d.]/g, '');
Â  Â  Â Â 
Â  Â  Â  // Permitir solo un punto decimal
Â  Â  Â  const parts = value.split('.');
Â  Â  Â  if (parts.length > 2) {
Â  Â  Â  Â  value = parts[0] + '.' + parts.slice(1).join('');
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  // Limitar decimales a 2 dÃ­gitos
Â  Â  Â  if (parts.length === 2 && parts[1].length > 2) {
Â  Â  Â  Â  value = parts[0] + '.' + parts[1].substring(0, 2);
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  if (value && !isNaN(parseFloat(value))) {
Â  Â  Â  Â  const numValue = parseFloat(value);
Â  Â  Â  Â  input.value = numValue.toLocaleString('es-CO', {
Â  Â  Â  Â  Â  minimumFractionDigits: 0,
Â  Â  Â  Â  Â  maximumFractionDigits: 2
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  }

Â  Â  function calculateTotal() {
Â  Â  Â  const unitario = document.getElementById("unitario").value;
Â  Â  Â  const num = document.getElementById("num").value;
Â  Â  Â Â 
Â  Â  Â  if (unitario && num) {
Â  Â  Â  Â  const unitarioValue = parseFloat(unitario.replace(/[^\d.]/g, '')) || 0;
Â  Â  Â  Â  const numValue = parseFloat(num) || 0;
Â  Â  Â  Â  const total = unitarioValue * numValue;
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!isNaN(total)) {
Â  Â  Â  Â  Â  document.getElementById("columnaL").value = total.toLocaleString('es-CO', {
Â  Â  Â  Â  Â  Â  minimumFractionDigits: 0,
Â  Â  Â  Â  Â  Â  maximumFractionDigits: 2
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }

Â  Â  function populateDropdown(selectId, values, defaultText = "Seleccione...") {
Â  Â  Â  const select = document.getElementById(selectId);
Â  Â  Â  select.innerHTML = `<option value="">${defaultText}</option>`;
Â  Â  Â Â 
Â  Â  Â  values.forEach(value => {
Â  Â  Â  Â  if (value && value.trim() !== "") {
Â  Â  Â  Â  Â  const opt = document.createElement("option");
Â  Â  Â  Â  Â  opt.value = value;
Â  Â  Â  Â  Â  opt.textContent = value;
Â  Â  Â  Â  Â  select.appendChild(opt);
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }

Â  Â  async function cargarDatos() {
Â  Â  Â  log("Cargando datos...");
Â  Â  Â  try {
Â  Â  Â  Â  const response = await fetch(API_URL);
Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Guardar la respuesta completa para debug
Â  Â  Â  Â  lastResponse = data;
Â  Â  Â  Â Â 
Â  Â  Â  Â  log("Datos recibidos (estructura completa):");
Â  Â  Â  Â  log(data);

Â  Â  Â  Â  if (data.status === "ok") {
Â  Â  Â  Â  Â  subproyectos = data.subproyectos || [];
Â  Â  Â  Â  Â  registros = data.registros || [];
Â  Â  Â  Â  Â  filteredSubproyectos = [...subproyectos]; // Inicializar lista filtrada
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  // Extraer valores Ãºnicos para los dropdowns
Â  Â  Â  Â  Â  tiposUnicos = [...new Set(registros.map(r => r.tipo).filter(t => t && t.trim() !== ""))].sort();
Â  Â  Â  Â  Â  tiposPersonalUnicos = [...new Set(registros.map(r => r.tipoPersonal).filter(tp => tp && tp.trim() !== ""))].sort();
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  log(`ğŸ¨ Encontrados ${tiposUnicos.length} tipos Ãºnicos: ${tiposUnicos.join(', ')}`);
Â  Â  Â  Â  Â  log(`ğŸ‘¥ Encontrados ${tiposPersonalUnicos.length} tipos de personal Ãºnicos: ${tiposPersonalUnicos.join(', ')}`);
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  // Inicializar el campo de bÃºsqueda
Â  Â  Â  Â  Â  document.getElementById("subproyecto").placeholder = `Buscar entre ${subproyectos.length} subproyectos...`;
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  showStatus(`Cargados ${subproyectos.length} subproyectos y ${registros.length} registros`);
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  // Actualizar info de debug automÃ¡ticamente
Â  Â  Â  Â  Â  showFullDebug();
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  throw new Error(data.message || "Error del servidor");
Â  Â  Â  Â  }
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  log("âŒ Error cargando datos: " + error.message);
Â  Â  Â  Â  showStatus("Error: " + error.message, true);
Â  Â  Â  Â  document.getElementById("subproyecto").placeholder = "Error al cargar datos";
Â  Â  Â  }
Â  Â  }

Â  Â  function onSubproyectoChange(subproyecto = null) {
Â  Â  Â  const selectedSubproyecto = subproyecto || document.getElementById("subproyecto").value;
Â  Â  Â Â 
Â  Â  Â  log(`Subproyecto seleccionado: ${selectedSubproyecto}`);
Â  Â  Â Â 
Â  Â  Â  // Restablecer todos los otros campos
Â  Â  Â  resetFormFields();
Â  Â  Â Â 
Â  Â  Â  if (!selectedSubproyecto) {
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  const registrosDelSub = registros.filter(r => r.subproyecto === selectedSubproyecto);
Â  Â  Â  const roles = [...new Set(registrosDelSub.map(r => r.rol).filter(r => r && r.trim()))];
Â  Â  Â Â 
Â  Â  Â  log(`Encontrados ${roles.length} roles para este subproyecto:`);
Â  Â  Â  log(roles);
Â  Â  Â  log("Registros del subproyecto (incluyendo todas las columnas):");
Â  Â  Â  log(registrosDelSub);
Â  Â  Â Â 
Â  Â  Â  const rolSelect = document.getElementById("rol");
Â  Â  Â  rolSelect.innerHTML = '<option value="">Seleccione rol...</option>';
Â  Â  Â  roles.forEach(rol => {
Â  Â  Â  Â  const opt = document.createElement("option");
Â  Â  Â  Â  opt.value = rol;
Â  Â  Â  Â  opt.textContent = rol;
Â  Â  Â  Â  rolSelect.appendChild(opt);
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  rolSelect.disabled = false;
Â  Â  }

Â  Â  function onRolChange() {
Â  Â  Â  const subproyecto = document.getElementById("subproyecto").value;
Â  Â  Â  const rol = document.getElementById("rol").value;
Â  Â  Â Â 
Â  Â  Â  if (!subproyecto || !rol) return;
Â  Â  Â Â 
Â  Â  Â  const registro = registros.find(r => r.subproyecto === subproyecto && r.rol === rol);
Â  Â  Â Â 
Â  Â  Â  // Habilitar y llenar los dropdowns de tipo
Â  Â  Â  populateDropdown("tipo", tiposUnicos, "Seleccione tipo...");
Â  Â  Â  populateDropdown("tipoPersonal", tiposPersonalUnicos, "Seleccione tipo de personal...");
Â  Â  Â Â 
Â  Â  Â  if (registro) {
Â  Â  Â  Â  document.getElementById("num").value = registro.num || "";
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Formatear valores monetarios al cargar
Â  Â  Â  Â  if (registro.unitario) {
Â  Â  Â  Â  Â  const unitarioValue = parseFloat(registro.unitario) || 0;
Â  Â  Â  Â  Â  document.getElementById("unitario").value = unitarioValue.toLocaleString('es-CO', {
Â  Â  Â  Â  Â  Â  minimumFractionDigits: 0,
Â  Â  Â  Â  Â  Â  maximumFractionDigits: 2
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  document.getElementById("unitario").value = "";
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (registro.columnaL) {
Â  Â  Â  Â  Â  const columnaLValue = parseFloat(registro.columnaL) || 0;
Â  Â  Â  Â  Â  document.getElementById("columnaL").value = columnaLValue.toLocaleString('es-CO', {
Â  Â  Â  Â  Â  Â  minimumFractionDigits: 0,
Â  Â  Â  Â  Â  Â  maximumFractionDigits: 2
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  document.getElementById("columnaL").value = "";
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById("tipo").value = registro.tipo || "";
Â  Â  Â  Â  document.getElementById("tipoPersonal").value = registro.tipoPersonal || "";
Â  Â  Â  Â  document.getElementById("formulario").dataset.rowIndex = registro.row;
Â  Â  Â  Â  log(`Cargando datos de fila ${registro.row} (incluyendo todas las columnas):`);
Â  Â  Â  Â  log(registro);
Â  Â  Â  } else {
Â  Â  Â  Â  document.getElementById("num").value = "";
Â  Â  Â  Â  document.getElementById("unitario").value = "";
Â  Â  Â  Â  document.getElementById("columnaL").value = "";
Â  Â  Â  Â  document.getElementById("tipo").value = "";
Â  Â  Â  Â  document.getElementById("tipoPersonal").value = "";
Â  Â  Â  Â  delete document.getElementById("formulario").dataset.rowIndex;
Â  Â  Â  Â  log("Nuevo registro");
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  // Habilitar todos los campos
Â  Â  Â  document.getElementById("num").disabled = false;
Â  Â  Â  document.getElementById("unitario").disabled = false;
Â  Â  Â  document.getElementById("columnaL").disabled = false;
Â  Â  Â  document.getElementById("tipo").disabled = false;
Â  Â  Â  document.getElementById("tipoPersonal").disabled = false;
Â  Â  Â  document.getElementById("guardar").disabled = false;
Â  Â  }

Â  Â  async function guardarDatos() {
Â  Â  Â  const btn = document.getElementById("guardar");
Â  Â  Â  btn.disabled = true;
Â  Â  Â  btn.textContent = "Guardando...";
Â  Â  Â Â 
Â  Â  Â  const payload = {
Â  Â  Â  Â  subproyecto: document.getElementById("subproyecto").value,
Â  Â  Â  Â  rol: document.getElementById("rol").value,
Â  Â  Â  Â  num: document.getElementById("num").value,
Â  Â  Â  Â  unitario: document.getElementById("unitario").value.replace(/[^\d.]/g, '') || "", // Limpiar formato
Â  Â  Â  Â  columnaL: document.getElementById("columnaL").value.replace(/[^\d.]/g, '') || "", // Limpiar formato
Â  Â  Â  Â  tipo: document.getElementById("tipo").value,
Â  Â  Â  Â  tipoPersonal: document.getElementById("tipoPersonal").value,
Â  Â  Â  Â  row: document.getElementById("formulario").dataset.rowIndex ?Â 
Â  Â  Â  Â  Â  Â  Â parseInt(document.getElementById("formulario").dataset.rowIndex) : null
Â  Â  Â  };
Â  Â  Â Â 
Â  Â  Â  log("Guardando (incluyendo todas las columnas):");
Â  Â  Â  log(payload);
Â  Â  Â Â 
Â  Â  Â  try {
Â  Â  Â  Â  const response = await fetch(API_URL, {
Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  Â  body: JSON.stringify(payload)
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  log("Respuesta guardado:");
Â  Â  Â  Â  log(data);
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (data.status === "ok") {
Â  Â  Â  Â  Â  showStatus("âœ… Guardado correctamente (incluyendo columnas L, M y N)");
Â  Â  Â  Â  Â  await cargarDatos();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  throw new Error(data.message);
Â  Â  Â  Â  }
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  log("âŒ Error guardando: " + error.message);
Â  Â  Â  Â  showStatus("Error: " + error.message, true);
Â  Â  Â  } finally {
Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  btn.textContent = "Guardar";
Â  Â  Â  }
Â  Â  }

Â  Â  // Inicializar y agregar eventos para cÃ¡lculo automÃ¡tico
Â  Â  window.addEventListener('load', () => {
Â  Â  Â  cargarDatos();
Â  Â  Â Â 
Â  Â  Â  // Agregar evento para cÃ¡lculo automÃ¡tico cuando cambie el nÃºmero
Â  Â  Â  document.getElementById("num").addEventListener('input', calculateTotal);

      // Agregar evento para ocultar el dropdown al hacer clic fuera
      document.addEventListener('click', function(event) {
          const subproyectoInput = document.getElementById("subproyecto");
          const subproyectoDropdown = document.getElementById("subproyecto-dropdown");

          // Si el clic no fue dentro del input ni dentro del dropdown, ocÃºltalo
          if (!subproyectoInput.contains(event.target) && !subproyectoDropdown.contains(event.target)) {
              hideDropdown();
          }
      });
Â  Â  });
Â  </script>
</body>
</html>

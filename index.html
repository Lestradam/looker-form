<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Formulario Looker - Debug</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .container { max-width: 800px; margin: 0 auto; padding: 20px; }
    label { display: block; margin-top: 15px; font-weight: bold; }
    input, select { width: 100%; padding: 10px; margin-top: 4px; box-sizing: border-box; }
    button { width: 100%; margin-top: 20px; padding: 12px; background: #007bff; color: white; border: none; cursor: pointer; }
    button:disabled { background: #cccccc; cursor: not-allowed; }
    .status { margin-top: 10px; padding: 10px; border-radius: 4px; display: none; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .debug-section { margin-top: 20px; padding: 15px; background: #e7f3ff; border: 2px solid #0066cc; border-radius: 5px; }
    .debug-title { font-weight: bold; color: #0066cc; margin-bottom: 10px; }
    .debug { margin-top: 10px; padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; font-family: monospace; font-size: 11px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Formulario Looker - Versi√≥n Debug</h2>
    
    <form id="formulario" onsubmit="return false;">
      <label for="subproyecto">Subproyecto:</label>
      <select id="subproyecto" onchange="onSubproyectoChange()">
        <option value="">Cargando...</option>
      </select>

      <label for="rol">Rol:</label>
      <select id="rol" disabled onchange="onRolChange()">
        <option value="">Seleccione subproyecto primero</option>
      </select>
      
      <label for="num">N√∫mero (#):</label>
      <input type="number" id="num" disabled>
      
      <label for="unitario">Valor Unitario:</label>
      <input type="number" step="any" id="unitario" disabled>

      <button onclick="guardarDatos()" id="guardar" disabled>Guardar</button>
    </form>
    
    <div id="status" class="status"></div>
    
    <div class="debug-section">
      <div class="debug-title">üìù LOG DE ACTIVIDAD</div>
      <div id="debug" class="debug">Iniciando aplicaci√≥n...\n</div>
    </div>
  </div>

  <script>
    // ==============================================================================
    //        !!! IMPORTANTE: CAMBIA ESTA URL POR LA NUEVA DE TU DESPLIEGUE !!!
    // ==============================================================================
    const API_URL = "https://script.google.com/macros/s/AKfycbwSt6LwtPfBrBNpnjGNAPuwEs4Zn467RLaAdDq8DDFUqw8J8EG1l6b-5MuPVmioCpjZ/exec";
    
    let registros = [];
    let subproyectos = [];

    function log(message) {
      const timestamp = new Date().toLocaleTimeString();
      const debugDiv = document.getElementById("debug");
      const messageStr = typeof message === 'object' ? JSON.stringify(message, null, 2) : message;
      debugDiv.textContent += `${timestamp}: ${messageStr}\n`;
      debugDiv.scrollTop = debugDiv.scrollHeight;
      console.log(message);
    }

    function showStatus(message, isError = false) {
      const statusDiv = document.getElementById("status");
      statusDiv.className = `status ${isError ? 'error' : 'success'}`;
      statusDiv.textContent = message;
      statusDiv.style.display = 'block';
      setTimeout(() => statusDiv.style.display = 'none', 5000);
    }

    async function cargarDatos() {
      log("Cargando datos...");
      document.getElementById("subproyecto").innerHTML = '<option value="">Cargando...</option>';
      try {
        const response = await fetch(API_URL);
        if (!response.ok) {
          throw new Error(`Error de red: ${response.status} ${response.statusText}`);
        }
        const data = await response.json();
        
        log("Datos recibidos del servidor:");
        log(data);

        if (data.status === "ok") {
          subproyectos = data.subproyectos || [];
          registros = data.registros || [];
          
          const select = document.getElementById("subproyecto");
          select.innerHTML = '<option value="">Seleccione un subproyecto...</option>';
          
          subproyectos.forEach(sp => {
            const opt = document.createElement("option");
            opt.value = sp;
            opt.textContent = sp;
            select.appendChild(opt);
          });
          
          showStatus(`Carga completa: ${subproyectos.length} subproyectos encontrados.`);
        } else {
          throw new Error(data.message || "El servidor devolvi√≥ un error");
        }
      } catch (error) {
        log("‚ùå Error cargando datos: " + error.message);
        showStatus("Error al cargar datos: " + error.message, true);
        document.getElementById("subproyecto").innerHTML = '<option value="">Error al cargar</option>';
      }
    }

    function onSubproyectoChange() {
      const subproyecto = document.getElementById("subproyecto").value;
      const rolSelect = document.getElementById("rol");
      
      log(`Subproyecto seleccionado: "${subproyecto}"`);
      resetFields(); // Resetea los campos al cambiar de subproyecto
      
      if (!subproyecto) {
        rolSelect.innerHTML = '<option value="">Seleccione subproyecto primero</option>';
        rolSelect.disabled = true;
        return;
      }

      const registrosDelSub = registros.filter(r => r.subproyecto === subproyecto);
      const roles = [...new Set(registrosDelSub.map(r => r.rol).filter(rol => rol && rol.trim()))];
      
      log(`Roles encontrados para este subproyecto: ${roles.join(', ')}`);
      
      rolSelect.innerHTML = '<option value="">Seleccione un rol...</option>';
      roles.forEach(rol => {
        const opt = document.createElement("option");
        opt.value = rol;
        opt.textContent = rol;
        rolSelect.appendChild(opt);
      });
      
      rolSelect.disabled = false;
    }

    function onRolChange() {
      const subproyecto = document.getElementById("subproyecto").value;
      const rol = document.getElementById("rol").value;
      
      if (!subproyecto || !rol) {
        resetFields();
        return;
      }
      
      const registro = registros.find(r => r.subproyecto === subproyecto && r.rol === rol);
      
      if (registro) {
        document.getElementById("num").value = registro.num || "";
        document.getElementById("unitario").value = registro.unitario || "";
        document.getElementById("formulario").dataset.rowIndex = registro.row;
        log(`Datos cargados para el rol "${rol}" (Fila: ${registro.row})`);
        
        document.getElementById("num").disabled = false;
        document.getElementById("unitario").disabled = false;
        document.getElementById("guardar").disabled = false;
      } else {
        log(`No se encontr√≥ un registro para la combinaci√≥n seleccionada.`);
        resetFields();
      }
    }

    function resetFields() {
      document.getElementById("num").value = "";
      document.getElementById("unitario").value = "";
      document.getElementById("num").disabled = true;
      document.getElementById("unitario").disabled = true;
      document.getElementById("guardar").disabled = true;
      delete document.getElementById("formulario").dataset.rowIndex;
    }

    async function guardarDatos() {
      const btn = document.getElementById("guardar");
      btn.disabled = true;
      btn.textContent = "Guardando...";
      
      const payload = {
        num: document.getElementById("num").value,
        unitario: document.getElementById("unitario").value,
        row: document.getElementById("formulario").dataset.rowIndex ? 
             parseInt(document.getElementById("formulario").dataset.rowIndex) : null
      };
      
      log("Enviando datos para guardar:");
      log(payload);
      
      try {
        const response = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
          // Google Apps Script a veces necesita 'redirect: "follow"'
          redirect: "follow" 
        });
        
        const data = await response.json();
        log("Respuesta del servidor al guardar:");
        log(data);
        
        if (data.status === "ok") {
          showStatus("‚úÖ ¬°Datos guardados correctamente!");
          // Actualiza el registro local para no tener que recargar todo
          const rowIndexInArray = registros.findIndex(r => r.row === payload.row);
          if (rowIndexInArray !== -1) {
              registros[rowIndexInArray].num = payload.num;
              registros[rowIndexInArray].unitario = payload.unitario;
          }
        } else {
          throw new Error(data.message || "Error desconocido al guardar");
        }
      } catch (error) {
        log("‚ùå Error guardando: " + error.message);
        showStatus("Error al guardar: " + error.message, true);
      } finally {
        btn.disabled = false;
        btn.textContent = "Guardar";
      }
    }

    // Inicializar la aplicaci√≥n al cargar la p√°gina
    window.addEventListener('load', cargarDatos);
  </script>
</body>
</html>

<!DOCTYPE html>

<html lang="es">

<head>

Â  <meta charset="UTF-8">

Â  <title>Formulario Looker - Debug</title>

Â  <style>

Â  Â  body { font-family: Arial, sans-serif; margin: 20px; }

Â  Â  .container { max-width: 800px; margin: 0 auto; padding: 20px; }

Â  Â  label { display: block; margin-top: 15px; font-weight: bold; }

Â  Â  input, select { width: 100%; padding: 10px; margin-top: 4px; box-sizing: border-box; }

Â  Â  button { width: 100%; margin-top: 20px; padding: 12px; background: #007bff; color: white; border: none; cursor: pointer; }

Â  Â  .debug { margin-top: 20px; padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; font-family: monospace; font-size: 11px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; }

Â  Â  .status { margin-top: 10px; padding: 10px; border-radius: 4px; display: none; }

Â  Â  .success { background: #d4edda; color: #155724; }

Â  Â  .error { background: #f8d7da; color: #721c24; }

Â  Â  .debug-section { margin-top: 20px; padding: 15px; background: #e7f3ff; border: 2px solid #0066cc; border-radius: 5px; }

Â  Â  .debug-title { font-weight: bold; color: #0066cc; margin-bottom: 10px; }

Â  </style>

</head>

<body>

Â  <div class="container">

Â  Â  <h2>Formulario Looker - VersiÃ³n Debug</h2>

Â  Â Â 

Â  Â  <button onclick="testConnection()">ğŸ§ª Test ConexiÃ³n</button>

Â  Â  <button onclick="showFullDebug()">ğŸ“Š Mostrar Debug Completo</button>



Â  Â  <form id="formulario" onsubmit="return false;">

Â  Â  Â  <label>Subproyecto:</label>

Â  Â  Â  <select id="subproyecto" onchange="onSubproyectoChange()">

Â  Â  Â  Â  <option value="">Cargando...</option>

Â  Â  Â  </select>



Â  Â  Â  <label>Rol:</label>

Â  Â  Â  <select id="rol" disabled onchange="onRolChange()">

Â  Â  Â  Â  <option value="">Seleccione subproyecto primero</option>

Â  Â  Â  </select>

Â  Â  Â Â 

Â  Â  Â  <label>NÃºmero:</label>

Â  Â  Â  <input type="text" id="num" disabled>

Â  Â  Â Â 

Â  Â  Â  <label>Valor Unitario:</label>

Â  Â  Â  <input type="text" id="unitario" disabled>



Â  Â  Â  <button onclick="guardarDatos()" id="guardar" disabled>Guardar</button>

Â  Â  </form>

Â  Â Â 

Â  Â  <div id="status" class="status"></div>

Â  Â Â 

Â  Â  <!-- SecciÃ³n de debug mejorada -->

Â  Â  <div class="debug-section">

Â  Â  Â  <div class="debug-title">ğŸ” INFORMACIÃ“N DE DEBUG</div>

Â  Â  Â  <div id="debug-info">No hay informaciÃ³n de debug disponible</div>

Â  Â  </div>

Â  Â Â 

Â  Â  <div class="debug-section">

Â  Â  Â  <div class="debug-title">ğŸ“ LOG DE ACTIVIDAD</div>

Â  Â  Â  <div id="debug" class="debug">Iniciando aplicaciÃ³n...\n</div>

Â  Â  </div>

Â  </div>



Â  <script>

Â  Â  // === CONFIG - CAMBIA ESTA URL POR LA TUYA ===

Â  Â  const API_URL = "https://script.google.com/macros/s/AKfycbzAYohlpVzOvh7YlFmERuFCnsRHzlufvWOQbuzK91zeAcxS3vsjvj4YAkX8_vWrAwuw/exec";

Â  Â Â 

Â  Â  let registros = [];

Â  Â  let subproyectos = [];

Â  Â  let lastResponse = null; // Para guardar la Ãºltima respuesta completa



Â  Â  function log(message) {

Â  Â  Â  const timestamp = new Date().toLocaleTimeString();

Â  Â  Â  const debugDiv = document.getElementById("debug");

Â  Â  Â  debugDiv.textContent += `${timestamp}: ${JSON.stringify(message)}\n`;

Â  Â  Â  debugDiv.scrollTop = debugDiv.scrollHeight;

Â  Â  Â  console.log(message);

Â  Â  }



Â  Â  function showStatus(message, isError = false) {

Â  Â  Â  const statusDiv = document.getElementById("status");

Â  Â  Â  statusDiv.className = `status ${isError ? 'error' : 'success'}`;

Â  Â  Â  statusDiv.textContent = message;

Â  Â  Â  statusDiv.style.display = 'block';

Â  Â  Â  setTimeout(() => statusDiv.style.display = 'none', 5000);

Â  Â  }



Â  Â  function showFullDebug() {

Â  Â  Â  if (lastResponse && lastResponse.debug) {

Â  Â  Â  Â  const debugInfo = document.getElementById("debug-info");

Â  Â  Â  Â  debugInfo.innerHTML = `

Â  Â  Â  Â  Â  <strong>ğŸ“Š InformaciÃ³n de la Hoja:</strong><br>

Â  Â  Â  Â  Â  â€¢ Total de filas: ${lastResponse.debug.totalFilas}<br>

Â  Â  Â  Â  Â  â€¢ Total de columnas: ${lastResponse.debug.totalColumnas}<br>

Â  Â  Â  Â  Â  â€¢ Subproyectos Ãºnicos: ${lastResponse.debug.subproyectosUnicos}<br>

Â  Â  Â  Â  Â  â€¢ Total registros: ${lastResponse.debug.totalRegistros}<br>

Â  Â  Â  Â  Â  â€¢ Registros con rol: ${lastResponse.debug.registrosConRol}<br><br>

Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  <strong>ğŸ“‹ Encabezados encontrados:</strong><br>

Â  Â  Â  Â  Â  ${lastResponse.debug.encabezados.map((h, i) => `Col ${i+1}: "${h}"`).join('<br>')}<br><br>

Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  <strong>ğŸ¯ Columnas utilizadas:</strong><br>

Â  Â  Â  Â  Â  â€¢ Subproyecto: Columna ${lastResponse.debug.columnasUsadas.subproyecto}<br>

Â  Â  Â  Â  Â  â€¢ Rol: Columna ${lastResponse.debug.columnasUsadas.rol}<br>

Â  Â  Â  Â  Â  â€¢ NÃºmero: Columna ${lastResponse.debug.columnasUsadas.num}<br>

Â  Â  Â  Â  Â  â€¢ Unitario: Columna ${lastResponse.debug.columnasUsadas.unitario}<br><br>

Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  <strong>ğŸ“ Primeros 3 registros:</strong><br>

Â  Â  Â  Â  Â  ${lastResponse.debug.primeros3Registros ?Â 

Â  Â  Â  Â  Â  Â  lastResponse.debug.primeros3Registros.map(r =>Â 

Â  Â  Â  Â  Â  Â  Â  `â€¢ "${r.subproyecto}" | "${r.rol}" | "${r.num}" | "${r.unitario}"`

Â  Â  Â  Â  Â  Â  ).join('<br>') : 'No hay registros'}

Â  Â  Â  Â  `;

Â  Â  Â  } else {

Â  Â  Â  Â  document.getElementById("debug-info").innerHTML = "âŒ No hay informaciÃ³n de debug. Ejecuta 'Cargar Datos' primero.";

Â  Â  Â  }

Â  Â  }



Â  Â  async function testConnection() {

Â  Â  Â  log("ğŸ§ª Probando conexiÃ³n...");

Â  Â  Â  try {

Â  Â  Â  Â  const response = await fetch(API_URL);

Â  Â  Â  Â  log("Response status: " + response.status);

Â  Â  Â  Â  log("Response headers: " + JSON.stringify([...response.headers.entries()]));

Â  Â  Â  Â Â 

Â  Â  Â  Â  const text = await response.text();

Â  Â  Â  Â  log("Response text (primeros 500 chars): " + text.substring(0, 500));

Â  Â  Â  Â Â 

Â  Â  Â  Â  try {

Â  Â  Â  Â  Â  const json = JSON.parse(text);

Â  Â  Â  Â  Â  log("JSON parseado exitosamente");

Â  Â  Â  Â  Â  log("Estructura completa del JSON:");

Â  Â  Â  Â  Â  log(json);

Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  // Mostrar debug si estÃ¡ disponible

Â  Â  Â  Â  Â  if (json.debug) {

Â  Â  Â  Â  Â  Â  log("=== INFORMACIÃ“N DE DEBUG ===");

Â  Â  Â  Â  Â  Â  log("Total filas: " + json.debug.totalFilas);

Â  Â  Â  Â  Â  Â  log("Total columnas: " + json.debug.totalColumnas);

Â  Â  Â  Â  Â  Â  log("Encabezados: " + JSON.stringify(json.debug.encabezados));

Â  Â  Â  Â  Â  Â  log("Columnas usadas: " + JSON.stringify(json.debug.columnasUsadas));

Â  Â  Â  Â  Â  Â  log("Registros encontrados: " + json.debug.totalRegistros);

Â  Â  Â  Â  Â  Â  log("Primeros 3 registros: " + JSON.stringify(json.debug.primeros3Registros));

Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  } catch(e) {

Â  Â  Â  Â  Â  log("Error parseando JSON: " + e.message);

Â  Â  Â  Â  }

Â  Â  Â  } catch (error) {

Â  Â  Â  Â  log("âŒ Error de conexiÃ³n: " + error.message);

Â  Â  Â  }

Â  Â  }



Â  Â  async function cargarDatos() {

Â  Â  Â  log("Cargando datos...");

Â  Â  Â  try {

Â  Â  Â  Â  const response = await fetch(API_URL);

Â  Â  Â  Â  const data = await response.json();

Â  Â  Â  Â Â 

Â  Â  Â  Â  // Guardar la respuesta completa para debug

Â  Â  Â  Â  lastResponse = data;

Â  Â  Â  Â Â 

Â  Â  Â  Â  log("Datos recibidos (estructura completa):");

Â  Â  Â  Â  log(data);



Â  Â  Â  Â  if (data.status === "ok") {

Â  Â  Â  Â  Â  subproyectos = data.subproyectos || [];

Â  Â  Â  Â  Â  registros = data.registros || [];

Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  const select = document.getElementById("subproyecto");

Â  Â  Â  Â  Â  select.innerHTML = '<option value="">Seleccione...</option>';

Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  subproyectos.forEach(sp => {

Â  Â  Â  Â  Â  Â  const opt = document.createElement("option");

Â  Â  Â  Â  Â  Â  opt.value = sp;

Â  Â  Â  Â  Â  Â  opt.textContent = sp;

Â  Â  Â  Â  Â  Â  select.appendChild(opt);

Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  log(`âœ… Cargados ${subproyectos.length} subproyectos y ${registros.length} registros`);

Â  Â  Â  Â  Â  showStatus(`Cargados ${subproyectos.length} subproyectos y ${registros.length} registros`);

Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  // Actualizar info de debug automÃ¡ticamente

Â  Â  Â  Â  Â  showFullDebug();

Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  throw new Error(data.message || "Error del servidor");

Â  Â  Â  Â  }

Â  Â  Â  } catch (error) {

Â  Â  Â  Â  log("âŒ Error cargando datos: " + error.message);

Â  Â  Â  Â  showStatus("Error: " + error.message, true);

Â  Â  Â  Â  document.getElementById("subproyecto").innerHTML = '<option value="">Error al cargar</option>';

Â  Â  Â  }

Â  Â  }



Â  Â  function onSubproyectoChange() {

Â  Â  Â  const subproyecto = document.getElementById("subproyecto").value;

Â  Â  Â  const rolSelect = document.getElementById("rol");

Â  Â  Â Â 

Â  Â  Â  log(`Subproyecto seleccionado: ${subproyecto}`);

Â  Â  Â Â 

Â  Â  Â  if (!subproyecto) {

Â  Â  Â  Â  rolSelect.innerHTML = '<option value="">Seleccione subproyecto primero</option>';

Â  Â  Â  Â  rolSelect.disabled = true;

Â  Â  Â  Â  return;

Â  Â  Â  }



Â  Â  Â  const registrosDelSub = registros.filter(r => r.subproyecto === subproyecto);

Â  Â  Â  const roles = [...new Set(registrosDelSub.map(r => r.rol).filter(r => r && r.trim()))];

Â  Â  Â Â 

Â  Â  Â  log(`Encontrados ${roles.length} roles para este subproyecto:`);

Â  Â  Â  log(roles);

Â  Â  Â  log("Registros del subproyecto:");

Â  Â  Â  log(registrosDelSub);

Â  Â  Â Â 

Â  Â  Â  rolSelect.innerHTML = '<option value="">Seleccione rol...</option>';

Â  Â  Â  roles.forEach(rol => {

Â  Â  Â  Â  const opt = document.createElement("option");

Â  Â  Â  Â  opt.value = rol;

Â  Â  Â  Â  opt.textContent = rol;

Â  Â  Â  Â  rolSelect.appendChild(opt);

Â  Â  Â  });

Â  Â  Â Â 

Â  Â  Â  rolSelect.disabled = false;

Â  Â  }



Â  Â  function onRolChange() {

Â  Â  Â  const subproyecto = document.getElementById("subproyecto").value;

Â  Â  Â  const rol = document.getElementById("rol").value;

Â  Â  Â Â 

Â  Â  Â  if (!subproyecto || !rol) return;

Â  Â  Â Â 

Â  Â  Â  const registro = registros.find(r => r.subproyecto === subproyecto && r.rol === rol);

Â  Â  Â Â 

Â  Â  Â  if (registro) {

Â  Â  Â  Â  document.getElementById("num").value = registro.num || "";

Â  Â  Â  Â  document.getElementById("unitario").value = registro.unitario || "";

Â  Â  Â  Â  document.getElementById("formulario").dataset.rowIndex = registro.row;

Â  Â  Â  Â  log(`Cargando datos de fila ${registro.row}:`);

Â  Â  Â  Â  log(registro);

Â  Â  Â  } else {

Â  Â  Â  Â  document.getElementById("num").value = "";

Â  Â  Â  Â  document.getElementById("unitario").value = "";

Â  Â  Â  Â  delete document.getElementById("formulario").dataset.rowIndex;

Â  Â  Â  Â  log("Nuevo registro");

Â  Â  Â  }

Â  Â  Â Â 

Â  Â  Â  document.getElementById("num").disabled = false;

Â  Â  Â  document.getElementById("unitario").disabled = false;

Â  Â  Â  document.getElementById("guardar").disabled = false;

Â  Â  }



Â  Â  async function guardarDatos() {

Â  Â  Â  const btn = document.getElementById("guardar");

Â  Â  Â  btn.disabled = true;

Â  Â  Â  btn.textContent = "Guardando...";

Â  Â  Â Â 

Â  Â  Â  const payload = {

Â  Â  Â  Â  subproyecto: document.getElementById("subproyecto").value,

Â  Â  Â  Â  rol: document.getElementById("rol").value,

Â  Â  Â  Â  num: document.getElementById("num").value,

Â  Â  Â  Â  unitario: document.getElementById("unitario").value,

Â  Â  Â  Â  row: document.getElementById("formulario").dataset.rowIndex ?Â 

Â  Â  Â  Â  Â  Â  Â parseInt(document.getElementById("formulario").dataset.rowIndex) : null

Â  Â  Â  };

Â  Â  Â Â 

Â  Â  Â  log("Guardando:");

Â  Â  Â  log(payload);

Â  Â  Â Â 

Â  Â  Â  try {

Â  Â  Â  Â  const response = await fetch(API_URL, {

Â  Â  Â  Â  Â  method: "POST",

Â  Â  Â  Â  Â  headers: { "Content-Type": "application/json" },

Â  Â  Â  Â  Â  body: JSON.stringify(payload)

Â  Â  Â  Â  });

Â  Â  Â  Â Â 

Â  Â  Â  Â  const data = await response.json();

Â  Â  Â  Â  log("Respuesta guardado:");

Â  Â  Â  Â  log(data);

Â  Â  Â  Â Â 

Â  Â  Â  Â  if (data.status === "ok") {

Â  Â  Â  Â  Â  showStatus("âœ… Guardado correctamente");

Â  Â  Â  Â  Â  await cargarDatos();

Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  throw new Error(data.message);

Â  Â  Â  Â  }

Â  Â  Â  } catch (error) {

Â  Â  Â  Â  log("âŒ Error guardando: " + error.message);

Â  Â  Â  Â  showStatus("Error: " + error.message, true);

Â  Â  Â  } finally {

Â  Â  Â  Â  btn.disabled = false;

Â  Â  Â  Â  btn.textContent = "Guardar";

Â  Â  Â  }

Â  Â  }



Â  Â  // Inicializar

Â  Â  window.addEventListener('load', cargarDatos);

Â  </script>

</body>

</html>

